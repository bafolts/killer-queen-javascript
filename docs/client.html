<!DOCTYPE html>
<html>
    <head>
        <title>Killer Queen Javascript</title>
        <link rel="stylesheet" href="index.css"></link>
<script type="text/javascript">
window.addEventListener("load", function() {
    var ws = new WebSocket("ws://localhost:8080");
    ws.binaryType = "arraybuffer";
    var axis = 0;
    var buttons = [];
    var bear = 0;
    var jumping = 0;
    function sendState() {
        console.log("Sending state");
        ws.send("0" + axis + jumping);
    }
    function setAxis(newAxis) {
        if (newAxis !== axis) {
            axis = newAxis;
            sendState();
        }
    }
    function setJumping(newJumping) {
        if (jumping !== newJumping) {
            jumping = newJumping;
            sendState();
        }
    }
    document.addEventListener("keyup", function(e) {
        if (e.keyCode === 37) {
            buttons[37] = 0;
            if (buttons[39] === 1) {
                setAxis(2);
            } else {
                setAxis(0);
            }
        } else if (e.keyCode === 39) {
            buttons[39] = 0;
            if (buttons[37] === 1) {
                setAxis(1);
            } else {
                setAxis(0);
            }
        } else if (e.keyCode === 32) {
            setJumping(0);
        }
    });
    document.addEventListener("keydown", function(e) {
        if (e.keyCode === 37) {
            buttons[37] = 1;
            setAxis(1);
        } else if (e.keyCode === 39) {
            buttons[39] = 1;
            setAxis(2);
        } else if (e.keyCode === 32) {
            setJumping(1);
        }
        // left = 37
        // right = 39
        // space = 32
        // down = 40
        console.log(e.keyCode);
    });
    ws.addEventListener("open", function() {
        console.log("Connected to server");
    });
    ws.addEventListener("message", function(m) {
        let message = new Uint16Array(m.data);
        if (message[0] === 0) {
            console.log("Got new level message");
            let bufferIndex = 1;
            while (bufferIndex < message.length) {
                if (message[bufferIndex] === 0) {
                    console.log("Got a wall");
                    let wall = document.createElement("div");
                    wall.style.top = message[bufferIndex + 1] + "px";
                    wall.style.left = message[bufferIndex + 2] + "px";
                    wall.style.height = message[bufferIndex + 3] + "px";
                    wall.style.width = message[bufferIndex + 4] + "px";
                    wall.className = "wall";
                    document.getElementById("stage").appendChild(wall);
                    bufferIndex += 5;
                } else if (message[bufferIndex] === 1) {
                    console.log("Got a platform");
                    let platform = document.createElement("div");
                    platform.style.top = message[bufferIndex + 1] + "px";
                    platform.style.left = message[bufferIndex + 2] + "px";
                    platform.style.width = message[bufferIndex + 3] + "px";
                    platform.className = "platform";
                    bufferIndex += 4;
                    document.getElementById("stage").appendChild(platform);
                } else {
                    throw new Error("Unknown item while parsing level");
                }
            }
        }
    });
});
</script>
    </head>
    <body>
        <div class="stage" id="stage"></div>
    </body>
</html>
